<?php

/**
 *
 * PHP Pro Bid
 *
 * @link        https://www.phpprobid.com
 * @copyright   Copyright (c) 2020 Online Ventures Software & CodeCube SRL
 * @license     https://www.phpprobid.com/license Commercial License
 *
 * @version     8.2 [rev.8.2.03]
 */

/**
 * sales table service class
 * creates/edits sales (a sale can include one ore more listings in it)
 */
/**
 * MOD:- SELLERS CREDIT
 * MOD:- ESCROW PAYMENTS
 * MOD:- DISCOUNT RULES
 * MOD:- CURRENCY SELECTOR
 * @version 1.1
 * MOD:- PICKUP LOCATIONS
 */

namespace Ppb\Service;

use Ppb\Db\Table,
    Cube\Db\Expr,
    Ppb\Service,
    Ppb\Service\Table\SalesListings as SalesListingsTableService,
    Ppb\Model\Shipping as ShippingModel,
    Ppb\Db\Table\Row\Sale as SaleModel,
    Ppb\Db\Table\Row\Listing as ListingModel,
    Ppb\Db\Table\Row\UserAddressBook as UserAddressBookModel;
## -- START :: ADD -- [ MOD:- CURRENCY SELECTOR ]
use Cube\Controller\Front,
    Ppb\Service\Table\Currencies as CurrenciesService,
    App\Controller\Plugin\CurrencySelector as CurrencySelectorPlugin;
## -- END :: ADD -- [ MOD:- CURRENCY SELECTOR ]

class Sales extends AbstractService
{


    /**
     * sales browse statuses
     */
    const STATUS_ACTIVATE = 'activate';
    const STATUS_COMBINE = 'combine';
    const STATUS_UNDELETE = 'undelete';
    const STATUS_DELETE = 'delete';

    /**
     *
     * the id of the sale row updated/created by a save operation
     *
     * @var int
     */
    protected $_saleId;

    /**
     *
     * status message generated by the changeStatus() method
     *
     * @var array
     */
    protected $_statusMessages = array(
        self::STATUS_ACTIVATE => array(
            self::STM_SINGULAR => "%s invoice has been activated.",
            self::STM_PLURAL   => "%s invoices have been activated.",
        ),
        self::STATUS_COMBINE  => array(
            self::STM_SINGULAR => "%s invoice has been combined.",
            self::STM_PLURAL   => "%s invoices have been combined.",
        ),
        self::STATUS_UNDELETE => array(
            self::STM_SINGULAR => "%s invoice has been undeleted.",
            self::STM_PLURAL   => "%s invoices have been undeleted.",
        ),
        self::STATUS_DELETE   => array(
            self::STM_SINGULAR => "%s invoice has been deleted.",
            self::STM_PLURAL   => "%s invoices have been deleted.",
        ),
    );

    /**
     *
     * sales listings table service
     *
     * @var \Ppb\Service\Table\SalesListings
     */
    protected $_salesListings;

    /**
     *
     * listings table service class
     *
     * @var \Ppb\Service\Listings
     */
    protected $_listings = null;

    /**
     *
     * reputation table service class
     *
     * @var \Ppb\Service\Reputation
     */
    protected $_reputation = null;

    ## -- START :: ADD -- [ MOD:- CURRENCY SELECTOR ]
    /**
     *
     * MOD:- CURRENCY SELECTOR
     * active currency
     *
     * @var string
     */
    protected $_activeCurrency = null;


    /**
     *
     * currencies table service
     *
     * @var \Ppb\Service\Table\Currencies
     */
    protected $_currencies;
    ## -- END :: ADD -- [ MOD:- CURRENCY SELECTOR ]

    /**
     *
     * class constructor
     */
    public function __construct()
    {
        parent::__construct();

        $this->setTable(
            new Table\Sales());
    }

    /**
     *
     * set sale id
     *
     * @param int $saleId
     *
     * @return $this
     */
    public function setSaleId($saleId)
    {
        $this->_saleId = $saleId;

        return $this;
    }

    /**
     *
     * get sale id
     *
     * @return int
     */
    public function getSaleId()
    {
        return $this->_saleId;
    }


    /**
     *
     * get sales listings table service
     *
     * @return \Ppb\Service\Table\SalesListings
     */
    public function getSalesListings()
    {
        if (!$this->_salesListings instanceof SalesListingsTableService) {
            $this->setSalesListings(
                new SalesListingsTableService());
        }

        return $this->_salesListings;
    }

    /**
     *
     * set sales listings table
     *
     * @param \Ppb\Service\Table\SalesListings $salesListings
     *
     * @return \Ppb\Service\Sales
     */
    public function setSalesListings(SalesListingsTableService $salesListings)
    {
        $this->_salesListings = $salesListings;

        return $this;
    }


    /**
     *
     * get listings table service class
     *
     * @return \Ppb\Service\Listings
     */
    public function getListings()
    {
        if (!$this->_listings instanceof Service\Listings) {
            $this->setListings(
                new Service\Listings());
        }

        return $this->_listings;
    }

    /**
     *
     * set listings table service class
     *
     * @param \Ppb\Service\Listings $listings
     *
     * @return \Ppb\Service\Sales
     */
    public function setListings(Service\Listings $listings)
    {
        $this->_listings = $listings;

        return $this;
    }

    /**
     *
     * get reputation table service class
     *
     * @return \Ppb\Service\Reputation
     */
    public function getReputation()
    {
        if (!$this->_reputation instanceof Service\Reputation) {
            $this->setReputation(
                new Service\Reputation());
        }

        return $this->_reputation;
    }

    /**
     *
     * set reputation table service class
     *
     * @param \Ppb\Service\Reputation $reputation
     *
     * @return \Ppb\Service\Sales
     */
    public function setReputation(Service\Reputation $reputation)
    {
        $this->_reputation = $reputation;

        return $this;
    }

    ## -- START :: ADD -- [ MOD:- CURRENCY SELECTOR ]
    /**
     *
     * MOD:- CURRENCY SELECTOR
     * set active currency
     *
     * @param string $activeCurrency
     *
     * @return $this
     */
    public function setActiveCurrency($activeCurrency)
    {
        $this->_activeCurrency = $activeCurrency;

        return $this;
    }

    /**
     *
     * MOD:- CURRENCY SELECTOR
     * get active currency
     *
     * @return string
     */
    public function getActiveCurrency()
    {
        if ($this->_activeCurrency === null) {
            $settings = $this->getSettings();
            if ($settings['enable_currency_selector']) {
                $session = Front::getInstance()->getBootstrap()->getResource('session');
                $selectedCurrency = $session->get(CurrencySelectorPlugin::SELECTED_CURRENCY);
                if (empty($selectedCurrency)) {
                    $selectedCurrency = $settings['currency'];
                }
                $this->setActiveCurrency(
                    $selectedCurrency);
            }
        }

        return $this->_activeCurrency;
    }


    /**
     *
     * get currencies table service
     *
     * @return \Ppb\Service\Table\Currencies
     */
    public function getCurrencies()
    {
        if (!$this->_currencies instanceof CurrenciesService) {
            $this->setCurrencies(
                new CurrenciesService());
        }

        return $this->_currencies;
    }

    /**
     *
     * set currencies service
     *
     * @param \Ppb\Service\Table\Currencies $currencies
     *
     * @return \Ppb\Model\Elements\AdminSettings
     */
    public function setCurrencies(CurrenciesService $currencies)
    {
        $this->_currencies = $currencies;

        return $this;
    }
    ## -- END :: ADD -- [ MOD:- CURRENCY SELECTOR ]

    /**
     *
     * create or edit a sale (invoice). when creating a sale, also add rows in
     * the sales listings table. when updating a sale, modify the sale id of the involved sales
     * listings, and then remove any sales that do not contain any listings.
     *
     * calculates the postage when creating or editing the invoice
     * the postage will be calculated based on the "postage_id" key, or the first option in the postage array will
     * be used if the "postage_id" key doesnt correspond to a key in the results array
     *
     * will also add the calculated or edited insurance amount if "apply_insurance" is checked.
     *
     * an element from the listings array must include:
     *      'listing' => object of type listing
     *      'price' => the price the listing has been sold for
     *      'quantity' => the quantity sold
     *
     * @8.2 when editing invoices, we make sure no sales_listings rows can be added
     *
     * @param array $post
     * @param bool  $canInsertSalesListings
     *
     * @return \Ppb\Service\Sales
     * @throws \InvalidArgumentException
     */
    public function save($post, $canInsertSalesListings = true)
    {
        ## -- ONE LINE :: CHANGE -- [ MOD:- CURRENCY SELECTOR ]
        $sale = $listing = $activeCurrency = null;
        
        ## -- START :: CHANGE -- [ MOD:- DISCOUNT RULES @version 1.0 ]
        $pending = 0;
        if (isset($post['pending'])) {
            $pending = $post['pending'];
            unset($post['pending']);
        }
        ## -- END :: CHANGE -- [ MOD:- DISCOUNT RULES @version 1.0 ]

        if ((empty($post['buyer_id']) || empty($post['user_token'])) && empty($post['seller_id'])) {
            throw new \InvalidArgumentException("The 'buyer_id'/'user_token' and 'seller_id' keys need to be specified when creating/editing a sale/shopping cart");
        }

        $data = $this->_prepareSaveData($post);

        if (array_key_exists('id', $data)) {
            $sale = $this->findBy('id', $data['id']);
            unset($data['id']);
        }

        $newSale = false;
        $pickUpOptions = null;

        if ($sale instanceof SaleModel) {
            if (!array_key_exists('edit_invoice', $post)) {
            $data['updated_at'] = new Expr('now()');
            }

            $sale->save($data);
            $id = $sale['id'];
        }
        else {
            $data['created_at'] = $data['updated_at'] = new Expr('now()');
            ## -- START :: ADD -- [ MOD:- DISCOUNT RULES @version 1.0 ]
            $data['pending'] = $pending;
            ## -- END :: ADD -- [ MOD:- DISCOUNT RULES @version 1.0 ]

            $this->_table->insert($data);
            $id = $this->_table->getAdapter()->lastInsertId();

            $listing = $this->getListings()->findBy('id', $post['listings'][0]['listing_id']);

            $pickUpOptions = $listing['pickup_options'];

            /** @var \Ppb\Db\Table\Row\Sale $sale */
            $sale = $this->findBy('id', $id);
            $sale->saveSaleData(array(
                'currency'       => $listing['currency'],
                'country'        => $listing['country'],
                'state'          => $listing['state'],
                'address'        => $listing['address'],
                'pickup_options' => $pickUpOptions,
                'apply_tax'      => $listing['apply_tax'],
                'tax_type_id'    => $listing['tax_type_id'],
                ## -- START :: ADD -- [ MOD:- ESCROW PAYMENTS ]
                'enable_escrow'  => $listing['enable_escrow'],
                ## -- END :: ADD -- [ MOD:- ESCROW PAYMENTS ]
            ));

            $newSale = true;
        }

        $this->setSaleId($id);

        if (isset($post['listings'])) {
            ## -- ONE LINE :: ADD -- [ MOD:- CURRENCY SELECTOR ]
            $currenciesService = new Service\Table\Currencies();
            foreach ($post['listings'] as $data) {
                $data['sale_id'] = $id;
                // for shopping carts, don't allow an item to be added to a cart more than once.
                if ($pending) {
                    $salesListingsTable = $this->getSalesListings()->getTable();
                    $select = $salesListingsTable->select('id')
                        ->where("listing_id = ?", $data['listing_id'])
                        ->where("sale_id = ?", $data['sale_id']);

                    if (!empty($data['product_attributes'])) {
                        $select->where("product_attributes = ?", $data['product_attributes']);
                    }

                    $saleListing = $salesListingsTable->fetchRow($select);
                    if ($saleListing) {
                        $data['id'] = $saleListing->getData('id');
                    }
                }
                $this->getSalesListings()->save($data, $canInsertSalesListings);
            }
        }

        if (!$pending) {
            $postageId = 0;
            if (!empty($post['postage_id'])) {
                $postageId = $post['postage_id'];
            }
            else if ($pickUpOptions == ShippingModel::MUST_PICKUP) {
                $postageId = ShippingModel::KEY_PICK_UP;
            }

            $applyInsurance = (!empty($post['apply_insurance'])) ? $post['apply_insurance'] : 0;

            $this->_processPostageFields($sale, $post, $postageId, $applyInsurance);

            if ($newSale || isset($post['checkout'])) {
                $this->_processPostSaleActions();
            }
        }


        return $this;
    }

    /**
     *
     * if a sale is complete, do the following actions:
     *
     * - save sale transaction to accounting table
     * - update the payer's balance if in account mode
     * - prepare reputation rows for each listing in the sale
     * - close any listings from the sale which had their quantity expired and update the quantity field in the listings table
     * - add the tax rate to the sale if tax applies
     * - set 'expires_at' field if force payment is enabled
     * - email seller and buyer
     * - V7.5: if sale total is 0.00 then flag_payment is set to 1
     * - V7.8: if auto relist if sold is enabled: relist
     *
     * @return $this
     */
    protected function _processPostSaleActions()
    {
        /** @var \Ppb\Db\Table\Row\Sale $sale */
        $sale = $this->findBy('id', $this->getSaleId());

        $settings = $this->getSettings();

        /** @var \Ppb\Db\Table\Row\User $seller */
        $seller = $sale->findParentRow('\Ppb\Db\Table\Users', 'Seller');

        /** @var \Ppb\Db\Table\Row\User $buyer */
        $buyer = $sale->findParentRow('\Ppb\Db\Table\Users', 'Buyer');

        /** @var \Ppb\Db\Table\Row\User $payer */
        $payer = ($settings['sale_fee_payer'] == 'buyer') ? $buyer : $seller;

        $saleTransactionService = new Service\Fees\SaleTransaction(
            $sale, $payer
        );

        $saleTransactionFees = $saleTransactionService->calculate();
        $totalAmount = $saleTransactionService->getTotalAmount();

        $accountingService = new Service\Accounting();

        if ($payer->userPaymentMode() == 'account') {
            $payer->updateBalance(
                $totalAmount);
            $sale->updateActive();

            $accountingService->setRefundFlag(\Ppb\Db\Table\Row\Accounting::REFUND_ALLOWED);
        }
        else if ($totalAmount <= 0) {
            $sale->updateActive();
        }

        ## -- START :: ADD -- [ MOD:- SELLERS CREDIT ]
        if ($seller->isForcePayment()) {
            $sale->setExpiresFlag();
        }

        if ($settings['enable_sellers_credit'] && $settings['automatic_credit_payments']) {
            $sale->canPaySellersCredit(true);

            // TODO: not ideal, copied basically the contents of the Payment\Ipn action -> we could also maybe redirect instead
            $transactionsService = new Transactions();
            $paymentGatewaysService = new Service\Table\PaymentGateways();

            $gateway = $paymentGatewaysService->findBy('name', 'SellersCredit');

            $ipnResult = 1;

            // save transaction row - as paid/completed
            $transaction = array(
                'name'                => array(
                    'string' => 'Direct Payment Purchase - Invoice ID: #%s',
                    'args'   => array($sale['id']),
                ),
                'amount'              => $sale->calculateTotal(),
                'currency'            => $sale['currency'],
                'user_id'             => $buyer['id'],
                'sale_id'             => $sale['id'],
                'gateway_id'               => $gateway['id'],
                'gateway_transaction_code' => 'SellersCreditAutomaticTXN',
                'status'                   => 'Completed',
                'paid'                     => (int)$ipnResult,
                'transaction_details' => serialize(array(
                    'class' => '\\Ppb\\Service\\Fees\\DirectPayment',
                    'data'  => array(
                        'sale_id' => $sale['id'],
                    ),
                )),
            );

            $transactionId = $transactionsService->save($transaction);

            // run callback process
            $transactionDetails = \Ppb\Utility::unserialize($transaction['transaction_details']);

            $className = $transactionDetails['class'];
            $feesService = new $className();

            if ($feesService instanceof Service\Fees) {
                $feesService->callback($ipnResult, $transactionDetails['data']);
            }

        }
        ## -- END :: ADD -- [ MOD:- SELLERS CREDIT ]

        $accountingService->setUserId($payer['id'])
            ->setSaleId($this->getSaleId())
            ->saveMultiple($saleTransactionFees);
        $reputation = $this->getReputation();

        $voucher = $sale->getVoucher();

        $salesListings = $sale->findDependentRowset('\Ppb\Db\Table\SalesListings');

        $listingIds = array();

        $taxCalculated = false;

        ## -- START :: ADD -- [ MOD:- CURRENCY SELECTOR ]
        $activeCurrency = $this->getActiveCurrency();
        $convert = false;
        ## -- END :: ADD -- [ MOD:- CURRENCY SELECTOR ]

        /** @var \Ppb\Db\Table\Row\SaleListing $saleListing */
        foreach ($salesListings as $saleListing) {
            /** @var \Ppb\Db\Table\Row\Listing $listing */
            $listing = $saleListing->findParentRow('\Ppb\Db\Table\Listings');

            // get tax rate - retrieved based on the first listing in the sale
            if ($taxCalculated !== true) {
                if (($taxType = $listing->getTaxType($buyer, $sale['billing_address_id'])) !== false) {
                    $sale->save(array(
                        'tax_rate' => $taxType->getData('amount')
                    ));
                }

                $taxCalculated = true;
            }

            $quantity = $listing->updateQuantity($saleListing['quantity'], $saleListing['product_attributes'], ListingModel::SUBTRACT);

            if ($quantity == 0) {
                $listing->close();
            }

            if ($voucher !== null) {
                $price = $voucher->apply($saleListing->price(), $sale['currency'], $listing['id']);
                $saleListing->save(array(
                    'price' => $price,
                ));
            }

            ## -- START :: ADD -- [ MOD:- CURRENCY SELECTOR ]
            /**
             *  MOD:- CURRENCY SELECTOR
             * - if we have an active currency that is different than the sale currency, apply conversions sale listings price fields
             */

            if ($listing->getData('listing_type') == 'product' && !empty($activeCurrency)) {
                $convert = true;
                $saleListing->save(array(
                    'price' => $this->getCurrencies()->convertAmount($saleListing['price'], $sale['currency'], $activeCurrency)
                ));
            }
            ## -- END :: ADD -- [ MOD:- CURRENCY SELECTOR ]

            // prepare reputation row: seller => buyer
            $reputation->save(array(
                'user_id'         => $sale['buyer_id'],
                'poster_id'       => $sale['seller_id'],
                'sale_listing_id' => $saleListing['id'],
                'listing_name'    => $listing['name'],
                'reputation_type' => Reputation::PURCHASE,
            ));

            // prepare reputation row: buyer => seller
            $reputation->save(array(
                'user_id'         => $sale['seller_id'],
                'poster_id'       => $sale['buyer_id'],
                'sale_listing_id' => $saleListing['id'],
                'listing_name'    => $listing['name'],
                'reputation_type' => Reputation::SALE,
            ));

            // relist only if the listing is closed
            if ($quantity == 0) {
                $listingIds[] = $listing['id'];
            }
        }

        ## -- START :: ADD -- [ MOD:- CURRENCY SELECTOR ]
        /**
         *  MOD:- CURRENCY SELECTOR
         * - if we have an active currency that is different than the sale currency, apply conversions to postage and insurance fields
         */
        if ($convert === true && !empty($activeCurrency)) {
            $sale->save(array(
                'postage_amount'   => $this->getCurrencies()->convertAmount($sale['postage_amount'], $sale['currency'], $activeCurrency),
                'insurance_amount' => $this->getCurrencies()->convertAmount($sale['insurance_amount'], $sale['currency'], $activeCurrency),
            ));

            $sale->saveSaleData(array(
                'currency' => $activeCurrency
            ));
        }
        ## -- END :: ADD -- [ MOD:- CURRENCY SELECTOR ]
        
        if ($voucher !== null) {
            $voucher->updateUses();
        }
        
        if (count($listingIds) > 0) {
            $select = $this->getListings()->getTable()->select()
                ->forUpdate()
                ->where('id IN (?)', $listingIds);

            $this->getListings()->fetchAll($select)
                ->setAutomatic(true)
                ->setAutoRelistPendingFlags();
        }

        if ($seller->isForcePayment()) {
            $sale->setExpiresFlag();
        }

        $sale->clearSalesListings();

        if ($sale->calculateTotal() <= 0) {
            $sale->save(array(
                'flag_payment' => 1,
            ));
            $sale->setExpiresFlag(true);
        }

        ## -- START :: ADD -- [ MOD:- DISCOUNT RULES @version 1.0 ]
        $sale->save(array(
            'pending' => 0,
        ));
        ## -- END :: ADD -- [ MOD:- DISCOUNT RULES @version 1.0 ]
        
        ## -- START :: ADD -- [ MOD:- SELLERS CREDIT ]
        /** @var \Ppb\Db\Table\Row\Sale $sale */
        $sale = $this->findBy('id', $this->getSaleId());
        ## -- END :: ADD -- [ MOD:- SELLERS CREDIT ]

        $mail = new \Members\Model\Mail\User();
        $mail->saleBuyerNotification($sale, $buyer)->send();
        $mail->saleSellerNotification($sale, $seller)->send();

        return $this;
    }


    /**
     *
     * process postage fields - calculate and save postage costs
     * the shipping_address_id field will always need to be set in the sale row
     * shipping needs to be enabled for this
     *
     *
     * @param \Ppb\Db\Table\Row\Sale $sale
     * @param array                  $post
     * @param int                    $postageId
     * @param int                    $applyInsurance
     *
     * @return $this
     */
    protected function _processPostageFields(SaleModel $sale, $post, $postageId, $applyInsurance)
    {
        /** @var \Ppb\Db\Table\Row\User $seller */
        $seller = $sale->findParentRow('\Ppb\Db\Table\Users', 'Seller');

        /** @var \Ppb\Db\Table\Row\User $buyer */
        $buyer = $sale->findParentRow('\Ppb\Db\Table\Users', 'Buyer');

        ## -- ONE LINE :: ADD -- [ MOD:- PICKUP LOCATIONS ]
        $pickup = (!empty($post['pickup'])) ? $post['pickup'] : 0;

        $shippingAddress = $buyer->getAddress($sale['shipping_address_id']);

        $shippingModel = new ShippingModel($seller);

        ## -- START :: CHANGE -- [ MOD:- PICKUP LOCATIONS ]
        if ($pickup == 1) {
            $shippingModel->setLocationId($post['locationId'])
                ->setPostCode($post['postCode'])
                ->setShippingDisplay(ShippingModel::DISPLAY_PICKUP);
        }
        else {
        $shippingModel->setLocationId($shippingAddress['country'])
                ->setPostCode($shippingAddress['zip_code'])
                ->setShippingDisplay(ShippingModel::DISPLAY_POSTAGE);
        }
        ## -- END :: CHANGE -- [ MOD:- PICKUP LOCATIONS ]

        $salesListings = $sale->findDependentRowset('\Ppb\Db\Table\SalesListings');

        /** @var \Ppb\Db\Table\Row\SaleListing $saleListing */
        foreach ($salesListings as $saleListing) {
            $shippingModel->addData(
                $saleListing->findParentRow('\Ppb\Db\Table\Listings'), $saleListing['quantity']);
        }

        $result = array();

        try {
            $result = $shippingModel->calculatePostage();
        } catch (\RuntimeException $e) {
        }

        $shippingDetails = (!empty($result[$postageId])) ? $result[$postageId] : reset($result);

        $insuranceAmount = (isset($post['insurance_amount'])) ? $post['insurance_amount'] : $shippingModel->calculateInsurance();
        $postageAmount = (isset($post['postage_amount'])) ? $post['postage_amount'] : $shippingDetails['price'];

        $sale->saveSaleData(array(
            'postage_id'      => $postageId,
            'apply_insurance' => $applyInsurance,
            'postage'         => $shippingDetails,
        ));

        $postageData = array(
            'postage_amount'   => (double)$postageAmount,
            'insurance_amount' => (double)$insuranceAmount
        );

        if ($shippingAddress instanceof UserAddressBookModel) {
            if ($shippingAddressId = $shippingAddress->getData('id')) {
                $postageData['shipping_address_id'] = $shippingAddressId;
            }
        }

        ## -- START :: ADD -- [ MOD:- PICKUP LOCATIONS ]
        if ($postageId < -1) {
            $storePickupLocationId = (-1) * $postageId;
            $storePickupLocationsService = new StorePickupLocations();

            $select = $storePickupLocationsService->getTable()->select()
                ->where('id = ?', $storePickupLocationId);
//                ->where('user_id = ?', $seller->getData('id'));

            $row = $storePickupLocationsService->fetchAll($select)->getRow(0);

            if (count($row) > 0) {
                $sale->save(array(
                    'store_pickup_location_id' => $storePickupLocationId,
                ));
            }
        }
        ## -- END :: ADD -- [ MOD:- PICKUP LOCATIONS ]

        $sale->save($postageData);

        return $this;
    }

    /**
     *
     * get all carts of a certain user based on his token
     *
     * @param string $userToken
     *
     * @return array
     */
    public function getMultiOptions($userToken)
    {
        $data = array();

        $select = $this->getTable()->select()
            ->where('pending = ?', 1)
            ->where('user_token = ?', $userToken)
            ->order(array('updated_at DESC', 'created_at DESC'));

        $rowset = $this->fetchAll($select);

        /** @var \Ppb\Db\Table\Row\Sale $row */
        foreach ($rowset as $row) {
            /** @var \Ppb\Db\Table\Row\User $seller */
            $seller = $row->findParentRow('\Ppb\Db\Table\Users', 'Seller');

            $data[(string)$row['id']] = '[ ' . $row['id'] . ' ] ' .
                (($seller->storeStatus(true) == true) ?
                    $seller->getData('store_name') : $seller->getData('username'));
        }

        return $data;
    }
}

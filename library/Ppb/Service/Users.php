<?php

/**
 *
 * PHP Pro Bid
 *
 * @link        http://www.phpprobid.com
 * @copyright   Copyright (c) 2020 Online Ventures Software & CodeCube SRL
 * @license     http://www.phpprobid.com/license Commercial License
 *
 * @version     8.2 [rev.8.2.01]
 */

/**
 * users table service class
 */

namespace Ppb\Service;

use Ppb\Db\Table\Users as UsersTable,
    Ppb\Service,
    Ppb\Model\Shipping as ShippingModel,
    Ppb\Db\Table\Row\User as UserModel,
    Cube\Db\Expr;

class Users extends AbstractService
{

    /**
     * admin user roles
     */
    const ADMIN_ROLE_PRIMARY = 'Admin';
    const ADMIN_ROLE_MANAGER = 'Manager';

    /**
     * users browse statuses
     */
    const STATUS_ACTIVATE = 'activate';
    const STATUS_SUSPEND = 'suspend';
    const STATUS_APPROVE = 'approve';
    const STATUS_VERIFY_EMAIL = 'verifyEmail';
    const STATUS_DELETE = 'delete';

    /**
     * custom fields tables "type" column
     */
    const CUSTOM_FIELDS_TYPE = 'user';

    /**
     *
     * admin roles
     *
     * @var array
     */
    protected static $_adminRoles = array(
        self::ADMIN_ROLE_PRIMARY => 'Administrator',
        self::ADMIN_ROLE_MANAGER => 'Manager',
    );

    /**
     *
     * status message generated by the changeStatus() method
     *
     * @var array
     */
    protected $_statusMessages = array(
        self::STATUS_ACTIVATE     => array(
            self::STM_SINGULAR => "%s user account has been activated.",
            self::STM_PLURAL   => "%s user accounts have been activated.",
        ),
        self::STATUS_SUSPEND      => array(
            self::STM_SINGULAR => "%s user account has been suspended.",
            self::STM_PLURAL   => "%s user accounts have been suspended.",
        ),
        self::STATUS_APPROVE      => array(
            self::STM_SINGULAR => "%s user account has been approved.",
            self::STM_PLURAL   => "%s user accounts have been approved.",
        ),
        self::STATUS_VERIFY_EMAIL => array(
            self::STM_SINGULAR => "%s user account has had its email addresses verified.",
            self::STM_PLURAL   => "%s user accounts have had their email addresses verified.",
        ),
        self::STATUS_DELETE       => array(
            self::STM_SINGULAR => "%s user account has been deleted.",
            self::STM_PLURAL   => "%s user accounts have been deleted.",
        ),
    );

    /**
     *
     * custom fields data table service
     *
     * @var \Ppb\Service\CustomFieldsData
     */
    protected $_customFieldsData;

    /**
     *
     * payment gateways service
     *
     * @var \Ppb\Service\Table\PaymentGateways
     */
    protected $_paymentGateways;

    /**
     *
     * users address book table service
     *
     * @var \Ppb\Service\UsersAddressBook
     */
    protected $_usersAddressBook;

    /**
     *
     * user subscriptions that are used when:
     * - disabling expired subscriptions,
     * - re-billing automatically in account mode
     * - notifying users by email that subscriptions are about to expire
     *
     * @var array
     */
    protected $_subscriptionTypes = array(
        'UserVerification'  => array(
            'name'           => 'User Verification Subscription',
            'active'         => 'user_verified',
            'expirationDate' => 'user_verified_next_payment',
            'emailFlag'      => 'user_verified_email',
            'updateMethod'   => 'updateUserVerification',
            'feesService'    => '\Ppb\Service\Fees\UserVerification',
            'renewalLink'    => array('module' => 'app', 'controller' => 'payment', 'action' => 'user-verification'),
            'managementLink' => array('module' => 'members', 'controller' => 'user', 'action' => 'verification'),
        ),
        'StoreSubscription' => array(
            'name'           => 'Store Subscription',
            'active'         => 'store_active',
            'expirationDate' => 'store_next_payment',
            'emailFlag'      => 'store_expiration_email',
            'updateMethod'   => 'updateStoreSubscription',
            'feesService'    => '\Ppb\Service\Fees\StoreSubscription',
            'renewalLink'    => array('module' => 'app', 'controller' => 'payment', 'action' => 'store-subscription'),
            'managementLink' => array('module' => 'members', 'controller' => 'store', 'action' => 'setup'),
        ),
    );

    /**
     *
     * stores select method params
     *
     * @var array
     */
    protected $_storesSelectParams = array();

    /**
     *
     * class constructor
     */
    public function __construct()
    {
        parent::__construct();

        $this->setTable(
            new UsersTable());
    }

    /**
     *
     * get custom fields data service
     *
     * @return \Ppb\Service\CustomFieldsData
     */
    public function getCustomFieldsDataService()
    {
        if (!$this->_customFieldsData instanceof Service\CustomFieldsData) {
            $this->setCustomFieldsDataService(
                new Service\CustomFieldsData());
        }

        return $this->_customFieldsData;
    }

    /**
     *
     * set custom fields data service
     *
     * @param \Ppb\Service\CustomFieldsData $customFieldsData
     *
     * @return \Ppb\Service\Users
     */
    public function setCustomFieldsDataService(Service\CustomFieldsData $customFieldsData)
    {
        $this->_customFieldsData = $customFieldsData;

        return $this;
    }

    /**
     *
     * get payment gateways service
     *
     * @return \Ppb\Service\Table\PaymentGateways
     */
    public function getPaymentGateways()
    {
        if (!$this->_paymentGateways instanceof Service\Table\PaymentGateways) {
            $this->setPaymentGateways(
                new Service\Table\PaymentGateways());
        }

        return $this->_paymentGateways;
    }

    /**
     *
     * set payment gateways service
     *
     * @param \Ppb\Service\Table\PaymentGateways $paymentGateways
     *
     * @return \Ppb\Service\Users
     */
    public function setPaymentGateways(Service\Table\PaymentGateways $paymentGateways)
    {
        $this->_paymentGateways = $paymentGateways;

        return $this;
    }

    /**
     *
     * get users address book service
     *
     * @return \Ppb\Service\UsersAddressBook
     */
    public function getUsersAddressBook()
    {
        if (!$this->_usersAddressBook instanceof Service\UsersAddressBook) {
            $this->setUsersAddressBook(
                new Service\UsersAddressBook());
        }

        return $this->_usersAddressBook;
    }

    /**
     *
     * set users address book service
     *
     * @param \Ppb\Service\UsersAddressBook $addressBook
     *
     * @return \Ppb\Service\Users
     */
    public function setUsersAddressBook(Service\UsersAddressBook $addressBook)
    {
        $this->_usersAddressBook = $addressBook;

        return $this;
    }

    /**
     *
     * get subscription types array
     *
     * @return array
     */
    public function getSubscriptionTypes()
    {
        return $this->_subscriptionTypes;
    }

    /**
     *
     * set subscription types array
     *
     * @param array $subscriptionTypes
     *
     * @return $this
     */
    public function setSubscriptionTypes($subscriptionTypes)
    {
        $this->_subscriptionTypes = $subscriptionTypes;

        return $this;
    }

    /**
     *
     * get stores select params
     *
     * @return array
     */
    public function getStoresSelectParams()
    {
        return $this->_storesSelectParams;
    }

    /**
     *
     * set stores select params
     *
     * @param array $storesSelectParams
     *
     * @return $this
     */
    public function setStoresSelectParams($storesSelectParams)
    {
        $this->_storesSelectParams = $storesSelectParams;

        return $this;
    }

    /**
     *
     * set admin roles
     *
     * @param $adminRoles
     */
    public static function setAdminRoles($adminRoles)
    {
        self::$_adminRoles = $adminRoles;
    }

    /**
     *
     * get admin roles
     *
     * @return array
     */
    public static function getAdminRoles()
    {
        return self::$_adminRoles;
    }

    /**
     *
     * find a row on the table by querying a certain column
     * also get the primary address from the UsersAddressBook table
     *
     * @param string $name     column name
     * @param string $value    column value
     * @param bool   $enhanced if set to true, it will retrieve all additional related data as an array (including the primary address)
     *
     * @return \Ppb\Db\Table\Row\User|null
     */
    public function findBy($name, $value, $enhanced = false)
    {
        /** @var \Ppb\Db\Table\Row\User|null $user */
        $user = parent::findBy($name, $value);

        if ($user instanceof UserModel) {
            $user->setAddress();

            if ($enhanced === true) {
                // custom fields data
                $customFieldsData = $this->getCustomFieldsData($user['id']);
                foreach ($customFieldsData as $key => $value) {
                    $user['custom_field_' . $key] = $value;
                }
            }
        }

        return $user;
    }

    /**
     *
     * save users data in the users table
     * also create the postage settings default array (type = item and shipping locations = domestic)
     *
     * @param array $post
     * @param int   $userId used for when editing a user
     *
     * @return int              the id of the user that was saved
     */
    public function save($post, $userId = null)
    {
        $user = null;

        $data = $this->_prepareSaveData($post);

        if ($userId !== null) {
            $user = $this->findBy('id', $userId);
        }
        else if (array_key_exists('username', $post)) {
            $user = $this->findBy('username', $post['username']);
        }

        if (isset($post['name'])) {
            $post['first_name'] = (!empty($post['name']['first'])) ? $post['name']['first'] : '';
            $post['last_name'] = (!empty($post['name']['last'])) ? $post['name']['last'] : '';
        }

        if ($user instanceof UserModel) {
            $data['updated_at'] = new Expr('now()');

            unset($data['username']);

            $this->_table->update($data, "id='{$user['id']}'");
            $id = $user['id'];
        }
        else {
            $data['created_at'] = new Expr('now()');

            if (!isset($data['postage_settings'])) {
                $data['postage_settings'] = serialize(array(
                    ShippingModel::SETUP_SHIPPING_LOCATIONS => ShippingModel::POSTAGE_LOCATION_DOMESTIC,
                    ShippingModel::SETUP_POSTAGE_TYPE       => ShippingModel::POSTAGE_TYPE_ITEM,
                    ShippingModel::SETUP_FREE_POSTAGE       => 0,
                ));
            }

            $settings = $this->getSettings();
            $data['balance'] = (-1) * $settings['signup_credit'];
            $data['max_debit'] = doubleval($settings['maximum_debit']);
            $data['account_mode'] = $settings['payment_mode'];

            $this->_table->insert($data);
            $id = $this->_table->getAdapter()->lastInsertId();

            $user = $this->findBy('id', $id);
        }

        if (!empty($post['password'])) {
            $this->savePassword($user, $post['password']);
        }

        if (!isset($post['partial'])) {
            // save custom fields data in the database
            foreach ($post as $key => $value) {
                if (strstr($key, 'custom_field_')) {
                    $fieldId = str_replace('custom_field_', '', $key);
                    $this->getCustomFieldsDataService()->save(
                        $value, self::CUSTOM_FIELDS_TYPE, $fieldId, $id);
                }
            }

            // save payment gateways data in the database
            $gatewayFields = $this->getPaymentGateways()->getDirectPaymentFields();
            foreach ($gatewayFields as $key => $gatewayField) {
                $gatewayFields[$key]['user_id'] = $id;
                if (array_key_exists($gatewayField['name'], $post)) {
                    $gatewayFields[$key]['value'] = $post[$gatewayField['name']];
                }
            }

            foreach ((array)$gatewayFields as $gatewayField) {
                $this->getPaymentGateways()->getPaymentGatewaysSettings()->save($gatewayField);
            }

            // save the user's address in the address book (but only if the address form - at least one field from it - is present)
            if (array_intersect($this->getUsersAddressBook()->getAddressFields(), array_keys($post))) {
                $this->getUsersAddressBook()->save($post, $id);
            }

            // subscribe user to newsletter or unsubscribe if box is unchecked.
            if (isset($data['newsletter_subscription'])) {
                $newslettersSubscribersService = new Service\NewslettersSubscribers();

                $subscribed = $newslettersSubscribersService->findBy('email', $data['email']);

                if ($data['newsletter_subscription'] && !$subscribed) {
                    $settings = $this->getSettings();

                    if ($settings['newsletter_subscription_email_confirmation']) {
                        $mail = new \Members\Model\Mail\User();
                        $mail->newsletterSubscriptionConfirmation($data['email'])->send();
                    }

                    $newslettersSubscribersService->save(array(
                        'newsletter_subscription' => 1,
                        'email'                   => $data['email'],
                        'user_id'                 => $id,
                        'confirmed'               => ($settings['newsletter_subscription_email_confirmation']) ? 0 : 1,
                    ));
                }
                else if (!$data['newsletter_subscription'] && $subscribed) {
                    $subscribed->delete();
                }
            }

        }

        return $id;
    }

    /**
     *
     * hash a password
     *
     * @param string $password
     * @param string $salt
     *
     * @return string   hashed password
     */
    public function hashPassword($password, $salt)
    {
        return hash('sha256', $password . $salt);
    }

    /**
     *
     * save a password for a certain user in the users table
     *
     * @param \Ppb\Db\Table\Row\User $user
     * @param string                 $password the raw password
     *
     * @return $this
     */
    public function savePassword(UserModel $user, $password)
    {
        $salt = date('U', time());
        $password = $this->hashPassword($password, $salt);

        $user->save(array(
            'password' => $password,
            'salt'     => $salt,
        ));

        return $this;
    }

    /**
     *
     * delete a user from the table
     *
     * @param integer $userId the id of the user
     *
     * @return integer      the number of affected rows
     */
    public function delete($userId)
    {
        $where = $this->_table->getAdapter()->quoteInto('id = ?', $userId);

        return $this->_table->delete($where);
    }

    /**
     *
     * verify an email address and return true if successful, false otherwise
     *
     * @param string $key the key used to verify the account
     *
     * @return bool
     */
    public function verifyEmailAddress($key)
    {
        return (bool)$this->_table->update(array('mail_activated' => 1), "registration_key='{$key}'");
    }

    /**
     *
     * unsubscribe user from newsletter
     *
     * @param string $username
     * @param string $email
     *
     * @return bool
     */
    public function newsletterUnsubscribe($username, $email)
    {
        return (bool)$this->_table->update(array('newsletter_subscription' => 0), "username='{$username}' AND email='{$email}'");
    }

    /**
     *
     * get the custom fields data of a certain user
     *
     * @param integer $id
     *
     * @return array
     */
    public function getCustomFieldsData($id)
    {
        $result = array();

        // custom fields data
        $rowset = $this->getCustomFieldsDataService()->fetchAll(
            $this->getCustomFieldsDataService()->getTable()->select('value, field_id')
                ->where('type = ?', self::CUSTOM_FIELDS_TYPE)
                ->where('owner_id = ?', (int)$id));

        foreach ($rowset as $row) {
            $result[$row['field_id']] = \Ppb\Utility::unserialize($row['value']);
        }

        return $result;
    }

    /**
     *
     * creates and returns a new \Cube\Db\Select object used for selecting stores
     *
     * @param array $params
     *
     * @return \Cube\Db\Select
     * @throws \InvalidArgumentException
     */
    public function storesSelect(array $params = null)
    {
        ## INITIALIZE USABLE VARIABLES
        $this->setStoresSelectParams($params);

        $keywords = $this->_getParam('keywords');
        $parentId = $this->_getParam('parent_id');
        $country = $this->_getParam('country');
        $filters = (array)$this->_getParam('filter');
        $sort = $this->_getParam('sort');
        ## /INITIALIZE USABLE VARIABLES


        ## INITIALIZE SELECT OBJECT
        $select = $this->getTable()->getAdapter()
            ->select()
            ->from(array('u' => 'users'), '*');
        ## /INITIALIZE SELECT OBJECT


        ## KEYWORDS
        if ($keywords) {
            $keywords = explode(' ', $keywords);
            $conditions = array();

            $conditions[] = 'u.store_name LIKE "%1$s"';
            $conditions[] = 'u.username LIKE "%1$s"';

            $cond = implode(' OR ', $conditions);

            foreach ((array)$keywords as $keyword) {
                $select->where('(' . sprintf($cond, '%' . $keyword . '%') . ')');
            }
        }
        ## /KEYWORDS


        ## CATEGORY ID AND SUBCATEGORIES
        if ($parentId) {
            $categoriesService = new Service\Table\Relational\Categories();

            $categoriesIds = array_keys($categoriesService->getChildren($parentId, true));

            $select->where('u.store_category_id IN (?)', $categoriesIds);
        }
        ## /CATEGORY ID AND SUBCATEGORIES


        ## SEARCH PAGE PARAMS
        ## :COUNTRY
        if ($country) {
            $select->joinLeft(array('a' => 'users_address_book'), 'a.user_id = u.id')
                ->where('a.is_primary = ?', 1)
                ->where('a.address REGEXP \'"country";s:[[:digit:]]+:"' . intval($country) . '"\'');
        }
        ## /:COUNTRY
        ## /SEARCH PAGE PARAMS


        ## FILTER
        // just filters data, doesnt order it
        $filters = array_unique($filters);

        foreach ($filters as $filter) {
            switch ($filter) {
                case 'active':
                    $select->where('u.active = ?', 1)
                        ->where('u.approved = ?', 1)
                        ->where('u.store_active = ?', 1);
                    break;
                case 'standard':
                    $select->joinLeft(array('s' => 'stores_subscriptions'), 's.id = u.store_subscription_id',
                        's.featured_store')
                        ->where('(s.featured_store = ? OR s.featured_store IS NULL)', 0)
                        ->where('u.store_subscription_id IS NOT NULL');
                    break;
                case 'featured':
                    $select->joinLeft(array('s' => 'stores_subscriptions'), 's.id = u.store_subscription_id',
                        's.featured_store')
                        ->where('s.featured_store = 1 OR u.store_subscription_id IS NULL');
                    break;
                case 'not-empty':
                    $select->joinLeft(array('l' => 'listings'), 'l.user_id = u.id', 'l.id as listing_id')
                        ->where('l.list_in != ?', 'site')
                        ->where('l.closed = ?', 0)
                        ->where('l.deleted = ?', 0)
                        ->where('l.active = ?', 1)
                        ->where('l.approved = ?', 1)
                        ->group('u.id');
                    break;

            }
        }
        ## /FILTER


        ## SORT
        // all data sorting is done here
        switch ($sort) {
            case 'name_asc':
                $select->order('IF(u.store_name="", u.username, u.store_name) ASC');
                break;
            case 'name_desc':
                $select->order('IF(u.store_name="", u.username, u.store_name) DESC');
                break;
            case 'rand':
                $select->order(new Expr('rand()'));
                break;
            default:
                if (!$select->getPart('order')) {
                    $select->order('u.created_at DESC');
                }
                break;
        }

        ## /SORT


        return $select;
    }

    /**
     *
     * prepare user data for when saving to the table
     *
     * @param array $data
     *
     * @return array
     */
    protected function _prepareSaveData($data = array())
    {
        if (isset($data['password'])) {
            unset($data['password']);
        }

        if (isset($data['salt'])) {
            unset($data['salt']);
        }

        if (!empty($data['birthdate'])) {
            $data['birthdate'] = date('Y-m-d H:i:s', strtotime($data['birthdate']));
        }

        return parent::_prepareSaveData($data);
    }

    /**
     *
     * check if variable exists and is not null in stores select params array
     *
     * @param string $key
     *
     * @return mixed|null
     */
    protected function _getParam($key)
    {
        $params = $this->getStoresSelectParams();

        if (isset($params[$key])) {
            return $params[$key];
        }

        return null;
    }

}

